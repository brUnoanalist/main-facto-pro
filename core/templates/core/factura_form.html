{% extends 'core/base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'facturas_list' %}">Facturas</a></li>
                    <li class="breadcrumb-item active">{{ titulo }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0">
                        <i class="bi bi-file-plus"></i> {{ titulo }}
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="facturaForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- Cliente -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.cliente.id_for_label }}" class="form-label">
                                    <i class="bi bi-person"></i> Cliente *
                                </label>
                                {{ form.cliente }}
                                {% if form.cliente.errors %}
                                    <div class="text-danger small mt-1">{{ form.cliente.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    ¿No está en la lista? <a href="{% url 'cliente_crear' %}" target="_blank">Crear nuevo cliente</a>
                                </small>
                            </div>

                            <!-- Número de Factura -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.numero_factura.id_for_label }}" class="form-label">
                                    <i class="bi bi-hash"></i> Número de Factura *
                                </label>
                                {{ form.numero_factura }}
                                {% if form.numero_factura.errors %}
                                    <div class="text-danger small mt-1">{{ form.numero_factura.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Debe ser único en el sistema</small>
                            </div>

                            <!-- Monto -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.monto.id_for_label }}" class="form-label">
                                    <i class="bi bi-cash-coin"></i> Monto *
                                </label>
                                {{ form.monto }}
                                {% if form.monto.errors %}
                                    <div class="text-danger small mt-1">{{ form.monto.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Moneda -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.moneda.id_for_label }}" class="form-label">
                                    <i class="bi bi-currency-exchange"></i> Moneda *
                                </label>
                                {{ form.moneda }}
                                {% if form.moneda.errors %}
                                    <div class="text-danger small mt-1">{{ form.moneda.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Selecciona la moneda de la factura</small>
                            </div>

                            <!-- Fecha Emisión -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.fecha_emision.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar"></i> Fecha Emisión *
                                </label>
                                {{ form.fecha_emision }}
                                {% if form.fecha_emision.errors %}
                                    <div class="text-danger small mt-1">{{ form.fecha_emision.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Fecha Vencimiento -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.fecha_vencimiento.id_for_label }}" class="form-label">
                                    <i class="bi bi-calendar-check"></i> Fecha Vencimiento *
                                </label>
                                {{ form.fecha_vencimiento }}
                                {% if form.fecha_vencimiento.errors %}
                                    <div class="text-danger small mt-1">{{ form.fecha_vencimiento.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Estado -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.estado.id_for_label }}" class="form-label">
                                    <i class="bi bi-flag"></i> Estado *
                                </label>
                                {{ form.estado }}
                                {% if form.estado.errors %}
                                    <div class="text-danger small mt-1">{{ form.estado.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Se actualizará automáticamente si vence</small>
                            </div>

                            <!-- Descripción -->
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                                    <i class="bi bi-text-paragraph"></i> Descripción / Concepto
                                </label>
                                {{ form.descripcion }}
                                {% if form.descripcion.errors %}
                                    <div class="text-danger small mt-1">{{ form.descripcion.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Detalle del servicio o producto facturado</small>
                            </div>
                        </div>

                        <!-- Vista previa de cálculos -->
                        <div class="card bg-light mt-3 mb-3">
                            <div class="card-body">
                                <h6 class="mb-3"><i class="bi bi-calculator"></i> Resumen</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Monto:</strong> <span id="preview-monto">$0</span></p>
                                        <p class="mb-0"><strong>Días hasta vencimiento:</strong> <span id="preview-dias">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Cliente:</strong> <span id="preview-cliente">-</span></p>
                                        <p class="mb-0"><strong>Estado:</strong> <span id="preview-estado">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'facturas_list' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-save"></i> Guardar Factura
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tarjeta de ayuda -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6><i class="bi bi-lightbulb"></i> Consejos</h6>
                    <ul class="mb-0 small text-muted">
                        <li>El sistema enviará recordatorios automáticos según tu configuración</li>
                        <li>Las facturas vencidas se marcarán automáticamente en rojo</li>
                        <li>Puedes exportar reportes desde el Dashboard o la lista de facturas</li>
                        <li>El número de factura debe ser único para evitar duplicados</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formMonto = document.getElementById('id_monto');
    const formCliente = document.getElementById('id_cliente');
    const formEstado = document.getElementById('id_estado');
    const formVencimiento = document.getElementById('id_fecha_vencimiento');
    
    function updatePreview() {
        // Actualizar monto
        const monto = formMonto?.value || '0';
        document.getElementById('preview-monto').textContent = '$' + parseFloat(monto).toLocaleString('es-CL');
        
        // Actualizar cliente
        const clienteSelect = formCliente;
        const clienteText = clienteSelect?.options[clienteSelect.selectedIndex]?.text || '-';
        document.getElementById('preview-cliente').textContent = clienteText;
        
        // Actualizar estado
        const estadoSelect = formEstado;
        const estadoText = estadoSelect?.options[estadoSelect.selectedIndex]?.text || '-';
        document.getElementById('preview-estado').textContent = estadoText;
        
        // Calcular días hasta vencimiento
        if (formVencimiento?.value) {
            const vencimiento = new Date(formVencimiento.value);
            const hoy = new Date();
            const diffTime = vencimiento - hoy;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                document.getElementById('preview-dias').innerHTML = '<span class="text-danger">Vencida hace ' + Math.abs(diffDays) + ' días</span>';
            } else if (diffDays === 0) {
                document.getElementById('preview-dias').innerHTML = '<span class="text-warning">Vence hoy</span>';
            } else if (diffDays <= 7) {
                document.getElementById('preview-dias').innerHTML = '<span class="text-warning">' + diffDays + ' días (próxima a vencer)</span>';
            } else {
                document.getElementById('preview-dias').innerHTML = '<span class="text-success">' + diffDays + ' días</span>';
            }
        }
    }
    
    // Event listeners
    formMonto?.addEventListener('input', updatePreview);
    formCliente?.addEventListener('change', updatePreview);
    formEstado?.addEventListener('change', updatePreview);
    formVencimiento?.addEventListener('change', updatePreview);
    
    // Actualizar al cargar
    updatePreview();
});
</script>
{% endblock %}